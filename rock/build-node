#!/usr/bin/env bash

src_path="$1"
dst_path="$2"

if [[ ! -f "${src_path}/package.json" ]]; then
  echo 'Node projects must contain a "package.json" file' >&2
  exit 1
fi

build-setup "$src_path" "$dst_path"

if [[ -e "${src_path}/node_modules" && ! -L "${src_path}/node_modules" ]]; then
  echo "node_modules exists and isn't a symbolic link" >&2
  exit 1
fi

if ! mkdir -p "${dst_path}/node_modules" >&2; then
  exit 1
fi

if [[ ! -L "${src_path}/node_modules" ]]; then
  ln -s "${dst_path}/node_modules" "${src_path}/node_modules"
fi

if ! npm install >&2 && npm rebuild >&2; then
  exit 1
fi
